services:
  # Keycloak
  # keycloak:
  #   image: quay.io/keycloak/keycloak:24.0.2
  #   container_name: dss-keycloak
  #   restart: on-failure
  #   env_file:
  #     - .env
  #   environment:
  #     KEYCLOAK_ADMIN: dev
  #     KEYCLOAK_ADMIN_PASSWORD: dev
  #     KC_DB: mysql
  #     KC_DB_URL: ${KEYCLOAK_DB_URL}
  #     KC_DB_USERNAME: dev
  #     KC_DB_PASSWORD: dev
  #   ports:
  #     - "8080:8080"
  #   command: start-dev
  #   healthcheck:
  #     test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: http://localhost\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"] 
  #     interval: 10s
  #     timeout: 10s
  #     retries: 120
  #     start_period: 30s

  # Settings Service
  settings-service:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/Settings_service
      dockerfile: Dockerfile
    container_name: dss-settings-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      SETTINGS_DB_NAME: ${SETTINGS_DB_NAME}
      SERVER_PORT: 21502
    ports:
      - "21502:21502"
    depends_on: {}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21502/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # User Service
  user-service:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/User_service
      dockerfile: Dockerfile
    container_name: dss-user-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      USER_DB_NAME: ${USER_DB_NAME}
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_URL}
      KEYCLOAK_REALM: master
      KEYCLOAK_CLIENT_ID: dss-client
      KEYCLOAK_CLIENT_SECRET: dss-secret
      SETTINGS_SERVICE_URL: http://settings-service:21502
      SERVER_PORT: 21501
    ports:
      - "21501:21501"
    depends_on:
      # keycloak:
      #   condition: service_healthy
      settings-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21501/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # Zone Service
  zone-service:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/zone_service
      dockerfile: Dockerfile
    container_name: dss-zone-service
    environment:
      NODE_ENV: production
      DB_HOST: ${DB_HOST} # not using
      DB_PORT: ${DB_PORT} # not using
      DB_USERNAME: ${DB_USERNAME} # not using
      DB_PASSWORD: ${DB_PASSWORD} # not using
      ZONE_DB_CONNECTION: ${ZONE_DB_CONNECTION}
      SETTINGS_SERVICE_URL: http://settings-service:21502
      # Motorbike OSRM instances (ports 25900-25904)
      OSRM_STRICT_PRIORITY_WITH_DELTA_URL: http://osrm-strict-priority-with-delta:5000
      OSRM_FLEXIBLE_PRIORITY_WITH_DELTA_URL: http://osrm-flexible-priority-with-delta:5000
      OSRM_STRICT_PRIORITY_NO_DELTA_URL: http://osrm-strict-priority-no-delta:5000
      OSRM_FLEXIBLE_PRIORITY_NO_DELTA_URL: http://osrm-flexible-priority-no-delta:5000
      OSRM_BASE_URL: http://osrm-base:5000
      # Car OSRM instances (ports 25910-25914)
      OSRM_CAR_STRICT_PRIORITY_WITH_DELTA_URL: http://osrm-car-strict-priority-with-delta:5000
      OSRM_CAR_FLEXIBLE_PRIORITY_WITH_DELTA_URL: http://osrm-car-flexible-priority-with-delta:5000
      OSRM_CAR_STRICT_PRIORITY_NO_DELTA_URL: http://osrm-car-strict-priority-no-delta:5000
      OSRM_CAR_FLEXIBLE_PRIORITY_NO_DELTA_URL: http://osrm-car-flexible-priority-no-delta:5000
      OSRM_CAR_BASE_URL: http://osrm-car-base:5000
      PORT: 21503
    ports:
      - "21503:21503"
    depends_on:
      settings-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://127.0.0.1:21503/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # API Gateway
  api-gateway:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/api-gateway
      dockerfile: Dockerfile
    container_name: dss-api-gateway
    environment:
      SPRING_PROFILES_ACTIVE: docker
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_URL}
      KEYCLOAK_REALM: master
      KEYCLOAK_CLIENT_ID: dss-client
      USER_SERVICE_URL: http://user-service:21501
      SETTINGS_SERVICE_URL: http://settings-service:21502
      ZONE_SERVICE_URL: http://zone-service:21503
      SERVER_PORT: 21500
    ports:
      - "21500:21500"
    depends_on:
      user-service:
        condition: service_healthy
      settings-service:
        condition: service_healthy
      zone-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21500/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # ============================================
  # MOTORBIKE OSRM INSTANCES (Ports 25900-25904)
  # ============================================

  # OSRM Strict Priority With Delta (Motorbike - Always follow priority, with AI delta/point_score)
  osrm-strict-priority-with-delta:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-strict-priority-with-delta
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-strict-priority-with-delta:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25900:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM Flexible Priority With Delta (Motorbike - Flexible priority, allows lower priority if convenient, with AI)
  osrm-flexible-priority-with-delta:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-flexible-priority-with-delta
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-flexible-priority-with-delta:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25901:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM Strict Priority No Delta (Motorbike - Always follow priority, NO AI recommendations)
  osrm-strict-priority-no-delta:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-strict-priority-no-delta
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-strict-priority-no-delta:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25902:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM Flexible Priority No Delta (Motorbike - Flexible priority, NO AI recommendations)
  osrm-flexible-priority-no-delta:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-flexible-priority-no-delta
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-flexible-priority-no-delta:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25903:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM Base (Motorbike - No overrides, pure base weights)
  osrm-base:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-base
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-base:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25904:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================
  # CAR OSRM INSTANCES (Ports 25910-25914)
  # ============================================

  # OSRM Car Strict Priority With Delta (Car - Always follow priority, with AI delta/point_score + dynamic weights)
  osrm-car-strict-priority-with-delta:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-car-strict-priority-with-delta
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-car-strict-priority-with-delta:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25910:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM Car Flexible Priority With Delta (Car - Flexible priority, allows lower priority if convenient, with AI + dynamic weights)
  osrm-car-flexible-priority-with-delta:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-car-flexible-priority-with-delta
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-car-flexible-priority-with-delta:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25911:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM Car Strict Priority No Delta (Car - Always follow priority, NO AI recommendations + dynamic weights)
  osrm-car-strict-priority-no-delta:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-car-strict-priority-no-delta
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-car-strict-priority-no-delta:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25912:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM Car Flexible Priority No Delta (Car - Flexible priority, NO AI recommendations + dynamic weights)
  osrm-car-flexible-priority-no-delta:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-car-flexible-priority-no-delta
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-car-flexible-priority-no-delta:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25913:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM Car Base (Car - Full OSRM car.lua profile with dynamic weights: priority_factor, rating, flow)
  osrm-car-base:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-car-base
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-car-base:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    ports:
      - "25914:5000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
