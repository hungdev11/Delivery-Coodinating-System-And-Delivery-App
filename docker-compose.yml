services:
  # ============================================
  # CORE INFRASTRUCTURE SERVICES (Start First)
  # ============================================

  # Settings Service - Priority service, starts first
  settings-service:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/Settings_service
      dockerfile: Dockerfile
    container_name: dss-settings-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      SETTINGS_DB_NAME: ${SETTINGS_DB_NAME}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21502
    # Ports removed - only accessible via nginx or docker network
    # Use docker-compose.debug.yml to expose ports for debugging
    depends_on:
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21502/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # User Service - Priority service, starts after settings-service
  user-service:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/User_service
      dockerfile: Dockerfile
    container_name: dss-user-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      USER_DB_NAME: ${USER_DB_NAME:-ds_user_service}
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-delivery-system}
      KEYCLOAK_CLIENT_ID: dss-client
      KEYCLOAK_CLIENT_SECRET: dss-secret
      SETTINGS_SERVICE_URL: http://settings-service:21502
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21501
    # Ports removed - only accessible via nginx or docker network
    # Use docker-compose.debug.yml to expose ports for debugging
    depends_on:
      settings-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21501/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # ============================================
  # MESSAGE BROKER SERVICES (Start Early)
  # ============================================

  # Zookeeper - Required for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: dss-zookeeper
    restart: on-failure
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Kafka - Depends on Zookeeper
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: dss-kafka
    restart: on-failure
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "9094:9094"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 120s

  # ============================================
  # BUSINESS SERVICES (Depend on Settings & Kafka)
  # ============================================

  # Zone Service
  zone-service:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/zone_service
      dockerfile: Dockerfile
    container_name: dss-zone-service
    environment:
      NODE_ENV: production
      DB_HOST: ${DB_HOST} # not using
      DB_PORT: ${DB_PORT} # not using
      DB_USERNAME: ${DB_USERNAME} # not using
      DB_PASSWORD: ${DB_PASSWORD} # not using
      ZONE_DB_CONNECTION: ${ZONE_DB_CONNECTION}
      SETTINGS_SERVICE_URL: http://settings-service:21502
      # Kafka Configuration
      KAFKA_BROKERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      # OSRM V2 URLs (Simplified Architecture)
      OSRM_V2_FULL_URL: http://osrm-v2-full:5000
      OSRM_V2_RATING_URL: http://osrm-v2-rating-only:5000
      OSRM_V2_BLOCKING_URL: http://osrm-v2-blocking-only:5000
      OSRM_V2_BASE_URL: http://osrm-v2-base:5000
      PORT: 21503
    # Ports removed - only accessible via nginx or docker network
    # Use docker-compose.debug.yml to expose ports for debugging
    depends_on:
      settings-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:21503/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

  # Parcel Service
  parcel-service:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/parcel-service
      dockerfile: Dockerfile
    container_name: dss-parcel-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      PARCEL_DB_NAME: ${PARCEL_DB_NAME:-ds_parcel_service}
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:21501}
      ZONE_SERVICE_URL: ${ZONE_SERVICE_URL:-http://zone-service:21503}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21506
    # Ports removed - only accessible via nginx or docker network
    # Use docker-compose.debug.yml to expose ports for debugging
    depends_on:
      settings-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21506/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # Session Service
  session-service:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/session-service
      dockerfile: Dockerfile
    container_name: dss-session-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      SESSION_DB_NAME: ${SESSION_DB_NAME:-ds_session_service}
      PARCEL_SERVICE_URL: ${PARCEL_SERVICE_URL:-http://parcel-service:21506}
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:21501}
      ZONE_SERVICE_URL: ${ZONE_SERVICE_URL:-http://zone-service:21503}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21505
    # Ports removed - only accessible via nginx or docker network
    # Use docker-compose.debug.yml to expose ports for debugging
    depends_on:
      settings-service:
        condition: service_healthy
      parcel-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      zone-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21505/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # Kafka UI (Optional - for monitoring)
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: dss-kafka-ui
    restart: on-failure
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: dss-kafka
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181

  # Communication Service
  communication-service:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/communication_service
      dockerfile: Dockerfile
    container_name: dss-communication-service
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      COMMUNICATION_DB_NAME: ${COMMUNICATION_DB_NAME:-ds_communication_service}
      SESSION_SERVICE_URL: ${SESSION_SERVICE_URL:-http://session-service:21505}
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:21501}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21511
    # Ports removed - only accessible via nginx or docker network
    # Use docker-compose.debug.yml to expose ports for debugging
    depends_on:
      settings-service:
        condition: service_healthy
      session-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21511/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # ============================================
  # GATEWAY & FRONTEND SERVICES (Start Last)
  # ============================================

  # API Gateway
  api-gateway:
    restart: on-failure
    env_file:
      - .env
    build:
      context: ./BE/api-gateway
      dockerfile: Dockerfile
    container_name: dss-api-gateway
    environment:
      SPRING_PROFILES_ACTIVE: docker
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_URL}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-delivery-system}
      KEYCLOAK_CLIENT_ID: dss-client
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:21501}
      SETTINGS_SERVICE_URL: ${SETTINGS_SERVICE_URL:-http://settings-service:21502}
      ZONE_SERVICE_URL: ${ZONE_SERVICE_URL:-http://zone-service:21503}
      SESSION_SERVICE_URL: ${SESSION_SERVICE_URL:-http://session-service:21505}
      PARCEL_SERVICE_URL: ${PARCEL_SERVICE_URL:-http://parcel-service:21506}
      COMMUNICATION_SERVICE_URL: ${COMMUNICATION_SERVICE_URL:-http://communication-service:21511}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21500
    # Ports removed - only accessible via nginx or docker network
    # Use docker-compose.debug.yml to expose ports for debugging
    depends_on:
      user-service:
        condition: service_healthy
      settings-service:
        condition: service_healthy
      zone-service:
        condition: service_healthy
      session-service:
        condition: service_healthy
      parcel-service:
        condition: service_healthy
      communication-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:21500/api/v1/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================
  # OSRM V2 Services (Simplified Architecture)
  # ============================================
  # NOTE: OSRM data builds are MANUAL ONLY via osrm-management-system
  # These containers only run the OSRM server with pre-built data
  # To build data: POST http://localhost:21520/api/v1/generate/osrm-v2
  # To manage containers: Use osrm-management-system API endpoints

  # OSRM V2 Full (Rating affects weight, Blocking affects speed)
  osrm-v2-full:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-v2-full
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-full:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    # Ports removed - only accessible via docker network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/route/v1/driving/106.7718,10.8505;106.8032,10.8623?overview=false || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # OSRM V2 Rating Only (User feedback affects weight)
  osrm-v2-rating-only:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-v2-rating-only
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-rating-only:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    # Ports removed - only accessible via docker network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/route/v1/driving/106.7718,10.8505;106.8032,10.8623?overview=false || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # OSRM V2 Blocking Only (Traffic affects speed)
  osrm-v2-blocking-only:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-v2-blocking-only
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-blocking-only:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    # Ports removed - only accessible via docker network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/route/v1/driving/106.7718,10.8505;106.8032,10.8623?overview=false || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # OSRM V2 Base (VN motorbike optimized, no modifiers)
  osrm-v2-base:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-v2-base
    restart: on-failure
    volumes:
      - ./BE/zone_service/osrm_data/osrm-base:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    # Ports removed - only accessible via docker network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/route/v1/driving/106.7718,10.8505;106.8032,10.8623?overview=false || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ManagementSystem Frontend Builder - Builds frontend and copies to shared volume
  management-system-builder:
    build:
      context: ./ManagementSystem
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-/api}
        VITE_WS_URL: ${VITE_WS_URL:-/api/ws}
        VITE_ENV: ${VITE_ENV:-production}
        VITE_MAPTILER_API_KEY: ${VITE_MAPTILER_API_KEY:-}
    environment:
      VITE_API_URL: ${VITE_API_URL:-/api}
      VITE_WS_URL: ${VITE_WS_URL:-/api/ws}
      VITE_ENV: ${VITE_ENV:-production}
      VITE_MAPTILER_API_KEY: ${VITE_MAPTILER_API_KEY:-}
    container_name: dss-management-system-builder
    image: dss-management-system:builder
    command: ["sh", "-c", "cp -r /app/dist/* /shared/ && echo 'ManagementSystem files copied to shared volume'"]
    volumes:
      - management-system-dist:/shared
    restart: "no"

  # Nginx Reverse Proxy - Serves frontend and proxies API requests
  nginx-proxy:
    image: nginx:alpine
    container_name: dss-nginx-proxy
    restart: unless-stopped
    volumes:
      - ./prod-pack/nginx.conf:/etc/nginx/nginx.conf:ro
      - management-system-dist:/usr/share/nginx/html:ro
    ports:
      - "8080:8080"
    depends_on:
      - management-system-builder
      - api-gateway
    environment:
      VITE_API_URL: ${VITE_API_URL:-/api}
      VITE_MAPTILER_API_KEY: ${VITE_MAPTILER_API_KEY:-}
      VITE_WS_URL: ${VITE_WS_URL:-/api/ws}
    healthcheck:
      test: ["CMD-SHELL", "pgrep nginx || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Cloudflare Tunnel - Exposes nginx-proxy to internet
  # Requires ./cloudflared/config.yml and credentials file
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: dss-cloudflared
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared:/etc/cloudflared:ro
    depends_on:
      nginx-proxy:
        condition: service_healthy

volumes:
  management-system-dist:
