# ==============================================
# Production Docker Compose for DSS
# ==============================================
# Required environment variables (set in .env or export):
#   - DB_HOST: MySQL host
#   - DB_USERNAME: MySQL username
#   - DB_PASSWORD: MySQL password
#
# Optional (has defaults):
#   - REPOSITORY_OWNER: GitHub username (default: phuongp2003)
#   - REGISTRY: Container registry (default: ghcr.io)
#   - IMAGE_TAG: Image tag (default: latest)
# ==============================================

services:
  # Settings Service (from CI/CD)
  settings-service:
    image: ${REGISTRY:-ghcr.io}/${REPOSITORY_OWNER:-phuongp2003}/dss-settings-service:${IMAGE_TAG:-latest}
    container_name: dss-settings-service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST:-127.0.0.1}
      DB_PORT: ${DB_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      SETTINGS_DB_NAME: ${SETTINGS_DB_NAME:-ds_settings_service}
      SERVER_PORT: 21502
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21502/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # User Service (from CI/CD)
  user-service:
    image: ${REGISTRY:-ghcr.io}/${REPOSITORY_OWNER:-phuongp2003}/dss-user-service:${IMAGE_TAG:-latest}
    container_name: dss-user-service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST:-127.0.0.1}
      DB_PORT: ${DB_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      USER_DB_NAME: ${USER_DB_NAME:-ds_user_service}
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_URL:-https://keylcoak.phuongy.works}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-delivery-system}
      KEYCLOAK_CLIENT_ID: dss-client
      KEYCLOAK_CLIENT_SECRET: dss-secret
      SETTINGS_SERVICE_URL: http://settings-service:21502
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21501
    depends_on:
      settings-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21501/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # ============================================
  # MESSAGE BROKER SERVICES (Start Early)
  # ============================================

  # Zookeeper (Required for Kafka)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: dss-zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    healthcheck:
      test: ["CMD", "echo", "ruok", "|", "nc", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Kafka
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: dss-kafka
    restart: unless-stopped
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 120s

  # Kafka UI (Optional - monitoring)
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: dss-kafka-ui
    restart: unless-stopped
    environment:
      KAFKA_CLUSTERS_0_NAME: dss-kafka
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    depends_on:
      kafka:
        condition: service_healthy
      zookeeper:
        condition: service_healthy

  # ============================================
  # BUSINESS SERVICES (Depend on Settings & Kafka)
  # ============================================

  # Zone Service (from CI/CD)
  zone-service:
    image: ${REGISTRY:-ghcr.io}/${REPOSITORY_OWNER:-phuongp2003}/dss-zone-service:${IMAGE_TAG:-latest}
    container_name: dss-zone-service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
      ZONE_DB_CONNECTION: mysql://${DB_USERNAME:-root}:${DB_PASSWORD:-root}@${DB_HOST:-127.0.0.1}:${DB_PORT:-3306}/${ZONE_DB_NAME:-ds_zone_service}
      SETTINGS_SERVICE_URL: http://settings-service:21502
      # OSRM V2 URLs (Simplified Architecture)
      OSRM_V2_FULL_URL: http://osrm-v2-full:5000
      OSRM_V2_RATING_URL: http://osrm-v2-rating-only:5000
      OSRM_V2_BLOCKING_URL: http://osrm-v2-blocking-only:5000
      OSRM_V2_BASE_URL: http://osrm-v2-base:5000
      PORT: 21503
    volumes:
      # Mount raw_data from host to allow adding files without rebuilding image
      - ./raw_data:/app/raw_data
      # Mount Docker socket to allow zone-service to run OSRM commands via Docker
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      settings-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:21503/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

  # Parcel Service (from CI/CD)
  parcel-service:
    image: ${REGISTRY:-ghcr.io}/${REPOSITORY_OWNER:-phuongp2003}/dss-parcel-service:${IMAGE_TAG:-latest}
    container_name: dss-parcel-service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST:-127.0.0.1}
      DB_PORT: ${DB_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      PARCEL_DB_NAME: ${PARCEL_DB_NAME:-ds_parcel_service}
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:21501}
      ZONE_SERVICE_URL: ${ZONE_SERVICE_URL:-http://zone-service:21503}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21506
    depends_on:
      settings-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21506/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # Session Service (from CI/CD)
  session-service:
    image: ${REGISTRY:-ghcr.io}/${REPOSITORY_OWNER:-phuongp2003}/dss-session-service:${IMAGE_TAG:-latest}
    container_name: dss-session-service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST:-127.0.0.1}
      DB_PORT: ${DB_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      SESSION_DB_NAME: ${SESSION_DB_NAME:-ds_session_service}
      PARCEL_SERVICE_URL: ${PARCEL_SERVICE_URL:-http://parcel-service:21506}
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:21501}
      ZONE_SERVICE_URL: ${ZONE_SERVICE_URL:-http://zone-service:21503}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21505
    depends_on:
      settings-service:
        condition: service_healthy
      parcel-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      zone-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21505/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # Communication Service (from CI/CD)
  communication-service:
    image: ${REGISTRY:-ghcr.io}/${REPOSITORY_OWNER:-phuongp2003}/dss-communication-service:${IMAGE_TAG:-latest}
    container_name: dss-communication-service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      DB_HOST: ${DB_HOST:-127.0.0.1}
      DB_PORT: ${DB_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      COMMUNICATION_DB_NAME: ${COMMUNICATION_DB_NAME:-ds_communication_service}
      SESSION_SERVICE_URL: ${SESSION_SERVICE_URL:-http://session-service:21505}
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:21501}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21511
    depends_on:
      settings-service:
        condition: service_healthy
      session-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:21511/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 120
      start_period: 30s

  # ============================================
  # GATEWAY & FRONTEND SERVICES (Start Last)
  # ============================================

  # API Gateway (from CI/CD)
  api-gateway:
    image: ${REGISTRY:-ghcr.io}/${REPOSITORY_OWNER:-phuongp2003}/dss-api-gateway:${IMAGE_TAG:-latest}
    container_name: dss-api-gateway
    restart: unless-stopped
    env_file:
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      KEYCLOAK_SERVER_URL: ${KEYCLOAK_URL:-https://keylcoak.phuongy.works}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-delivery-system}
      KEYCLOAK_CLIENT_ID: dss-client
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:21501}
      SETTINGS_SERVICE_URL: ${SETTINGS_SERVICE_URL:-http://settings-service:21502}
      ZONE_SERVICE_URL: ${ZONE_SERVICE_URL:-http://zone-service:21503}
      SESSION_SERVICE_URL: ${SESSION_SERVICE_URL:-http://session-service:21505}
      PARCEL_SERVICE_URL: ${PARCEL_SERVICE_URL:-http://parcel-service:21506}
      COMMUNICATION_SERVICE_URL: ${COMMUNICATION_SERVICE_URL:-http://communication-service:21511}
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SERVER_PORT: 21500
    depends_on:
      user-service:
        condition: service_healthy
      settings-service:
        condition: service_healthy
      zone-service:
        condition: service_healthy
      session-service:
        condition: service_healthy
      parcel-service:
        condition: service_healthy
      communication-service:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:21500/api/v1/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ManagementSystem Frontend (from CI/CD)
  management-system:
    image: ${REGISTRY:-ghcr.io}/${REPOSITORY_OWNER:-phuongp2003}/dss-management-system:${IMAGE_TAG:-latest}
    container_name: dss-management-system
    restart: unless-stopped
    command: ["sh", "-c", "cp -r /app/dist/* /shared/ && echo 'ManagementSystem files copied to shared volume' && tail -f /dev/null"]
    volumes:
      - management-system-dist:/shared
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "test", "-f", "/shared/index.html"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Nginx Reverse Proxy - Serves frontend and proxies API requests
  nginx-proxy:
    image: nginx:alpine
    container_name: dss-nginx-proxy
    restart: unless-stopped
    volumes:
      - ./prod-pack/nginx.conf:/etc/nginx/nginx.conf:ro
      - management-system-dist:/usr/share/nginx/html:ro
    ports:
      - "8080:8080"
      - "8081:8081"
    depends_on:
      management-system:
        condition: service_healthy
      api-gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep nginx || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ============================================
  # OSRM V2 Services (Simplified Architecture)
  # ============================================

  # OSRM V2 Full (Rating affects weight, Blocking affects speed)
  osrm-v2-full:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-v2-full
    restart: on-failure
    profiles:
      - osrm-manual
    volumes:
      - ./osrm_data/osrm-full:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM V2 Rating Only (User feedback affects weight)
  osrm-v2-rating-only:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-v2-rating-only
    restart: on-failure
    profiles:
      - osrm-manual
    volumes:
      - ./osrm_data/osrm-rating-only:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM V2 Blocking Only (Traffic affects speed)
  osrm-v2-blocking-only:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-v2-blocking-only
    restart: on-failure
    profiles:
      - osrm-manual
    volumes:
      - ./osrm_data/osrm-blocking-only:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # OSRM V2 Base (VN motorbike optimized, no modifiers)
  osrm-v2-base:
    image: osrm/osrm-backend:latest
    container_name: dss-osrm-v2-base
    restart: on-failure
    profiles:
      - osrm-manual
    volumes:
      - ./osrm_data/osrm-base:/data:ro
    command: osrm-routed --algorithm mld --max-table-size 10000 /data/network.osrm
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/5000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  management-system-dist:
