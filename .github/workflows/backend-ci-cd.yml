name: Backend CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'BE/**'
  pull_request:
    branches: [ "main", "develop" ]
    paths:
      - 'BE/**'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_PREFIX: dss
  REPOSITORY_OWNER: ${{ github.repository_owner }}

jobs:
  # Job 0: Validate Token
  validate-token:
    runs-on: ubuntu-latest
    steps:
      - name: Check DEPLOY_TOKEN
        run: |
          if [ -z "${{ secrets.DEPLOY_TOKEN }}" ]; then
            echo "❌ DEPLOY_TOKEN not configured"
            exit 1
          fi
          echo "✅ DEPLOY_TOKEN configured"

  # Job 1: Detect changed services
  detect-changes:
    needs: validate-token
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      user-service: ${{ steps.changes.outputs.user-service }}
      settings-service: ${{ steps.changes.outputs.settings-service }}
      zone-service: ${{ steps.changes.outputs.zone-service }}
      parcel-service: ${{ steps.changes.outputs.parcel-service }}
      session-service: ${{ steps.changes.outputs.session-service }}
      communication-service: ${{ steps.changes.outputs.communication-service }}
      any-service: ${{ steps.changes.outputs.any-service }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            api-gateway:
              - 'BE/api-gateway/**'
            user-service:
              - 'BE/User_service/**'
            settings-service:
              - 'BE/Settings_service/**'
            zone-service:
              - 'BE/zone_service/**'
            parcel-service:
              - 'BE/parcel-service/**'
            session-service:
              - 'BE/session-service/**'
            communication-service:
              - 'BE/communication_service/**'
            any-service:
              - 'BE/**'

  # Job 2: Test API Gateway
  test-api-gateway:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api-gateway == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
          cache-dependency-path: BE/api-gateway/pom.xml

      - name: Run API Gateway Tests
        working-directory: BE/api-gateway
        run: |
          chmod +x mvnw
          ./mvnw -B -ntp clean test

  # Job 3: Test User Service
  test-user-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.user-service == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
          cache-dependency-path: BE/User_service/pom.xml

      - name: Run User Service Tests
        working-directory: BE/User_service
        run: |
          chmod +x mvnw
          ./mvnw -B -ntp clean test

  # Job 4: Test Settings Service
  test-settings-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.settings-service == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
          cache-dependency-path: BE/Settings_service/pom.xml

      - name: Run Settings Service Tests
        working-directory: BE/Settings_service
        run: |
          chmod +x mvnw
          ./mvnw -B -ntp clean test

  # Job 5: Test Zone Service
  test-zone-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.zone-service == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: BE/zone_service/package-lock.json

      - name: Install dependencies
        working-directory: BE/zone_service
        run: npm ci

      - name: Run Zone Service Tests
        working-directory: BE/zone_service
        run: |
          npm run build
          # Run optional checks (statistics only) - these are informational, not blocking
          # npm run check:all || echo "Optional checks completed with warnings"

  # Job 6: Test Parcel Service
  test-parcel-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.parcel-service == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
          cache-dependency-path: BE/parcel-service/pom.xml

      - name: Run Parcel Service Tests
        working-directory: BE/parcel-service
        run: |
          chmod +x mvnw || echo "mvnw not found, using system mvn"
          ./mvnw -B -ntp clean test || mvn -B -ntp clean test

  # Job 7: Test Session Service
  test-session-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.session-service == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
          cache-dependency-path: BE/session-service/pom.xml

      - name: Run Session Service Tests
        working-directory: BE/session-service
        run: |
          chmod +x mvnw || echo "mvnw not found, using system mvn"
          ./mvnw -B -ntp clean test || mvn -B -ntp clean test

  # Job 8: Test Communication Service
  test-communication-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.communication-service == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
          cache-dependency-path: BE/communication_service/pom.xml

      - name: Run Communication Service Tests
        working-directory: BE/communication_service
        run: |
          chmod +x mvnw || echo "mvnw not found, using system mvn"
          ./mvnw -B -ntp clean test || mvn -B -ntp clean test

  # Job 9: Integration Tests (Non-blocking)
  integration-tests:
    runs-on: ubuntu-latest
    needs: [detect-changes, test-api-gateway, test-user-service, test-settings-service, test-zone-service, test-parcel-service, test-session-service, test-communication-service]
    if: always() && needs.detect-changes.outputs.any-service == 'true'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services with Docker Compose
        run: |
          docker-compose -f docker-compose.test.yml up -d --build
          echo "Waiting for services to be healthy..."
          sleep 60  # Wait for services to start

      - name: Check service health
        run: |
          echo "Checking service health..."
          # Check API Gateway
          curl -f http://localhost:21500/actuator/health || echo "⚠️ API Gateway health check failed"
          # Check User Service
          curl -f http://localhost:21501/actuator/health || echo "⚠️ User Service health check failed"
          # Check Settings Service
          curl -f http://localhost:21502/actuator/health || echo "⚠️ Settings Service health check failed"
          echo "✅ Health checks completed (warnings are non-blocking)"

      - name: Run Integration Tests
        continue-on-error: true
        run: |
          echo "Running integration tests..."
          # Add your integration test commands here
          # Example: npm test, mvn test, curl endpoints, etc.
          echo "ℹ️ Integration tests completed (non-blocking)"

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== API Gateway Logs ==="
          docker logs dss-api-gateway-test --tail 50 || true
          echo "=== User Service Logs ==="
          docker logs dss-user-service-test --tail 50 || true
          echo "=== Settings Service Logs ==="
          docker logs dss-settings-service-test --tail 50 || true

      - name: Stop services
        if: always()
        run: |
          docker-compose -f docker-compose.test.yml down -v || true

  # Job 10: Build and Push Docker Images
  build-and-push:
    runs-on: ubuntu-latest
    needs: [detect-changes, test-api-gateway, test-user-service, test-settings-service, test-zone-service, test-parcel-service, test-session-service, test-communication-service]
    if: |
      needs.detect-changes.outputs.any-service == 'true' &&
      (needs.test-api-gateway.result == 'success' || needs.test-api-gateway.result == 'skipped') &&
      (needs.test-user-service.result == 'success' || needs.test-user-service.result == 'skipped') &&
      (needs.test-settings-service.result == 'success' || needs.test-settings-service.result == 'skipped') &&
      (needs.test-zone-service.result == 'success' || needs.test-zone-service.result == 'skipped') &&
      (needs.test-parcel-service.result == 'success' || needs.test-parcel-service.result == 'skipped') &&
      (needs.test-session-service.result == 'success' || needs.test-session-service.result == 'skipped') &&
      (needs.test-communication-service.result == 'success' || needs.test-communication-service.result == 'skipped')
    strategy:
      matrix:
        service:
          - name: api-gateway
            path: BE/api-gateway
            condition: ${{ needs.detect-changes.outputs.api-gateway == 'true' }}
          - name: user-service
            path: BE/User_service
            condition: ${{ needs.detect-changes.outputs.user-service == 'true' }}
          - name: settings-service
            path: BE/Settings_service
            condition: ${{ needs.detect-changes.outputs.settings-service == 'true' }}
          - name: zone-service
            path: BE/zone_service
            condition: ${{ needs.detect-changes.outputs.zone-service == 'true' }}
          - name: parcel-service
            path: BE/parcel-service
            condition: ${{ needs.detect-changes.outputs.parcel-service == 'true' }}
          - name: session-service
            path: BE/session-service
            condition: ${{ needs.detect-changes.outputs.session-service == 'true' }}
          - name: communication-service
            path: BE/communication_service
            condition: ${{ needs.detect-changes.outputs.communication-service == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REPOSITORY_OWNER }}
          password: ${{ secrets.DEPLOY_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Node.js (for package.json parsing)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract package information
        id: package-info
        working-directory: ${{ matrix.service.path }}
        run: |
          if [ -f "pom.xml" ]; then
            # Extract Maven package info
            GROUP_ID=$(grep -oP '<groupId>\K[^<]+' pom.xml | head -1 || echo "unknown")
            ARTIFACT_ID=$(grep -oP '<artifactId>\K[^<]+' pom.xml | head -1 || echo "unknown")
            VERSION=$(grep -oP '<version>\K[^<]+' pom.xml | head -1 || echo "unknown")
            DESCRIPTION=$(grep -oP '<description>\K[^<]+' pom.xml | head -1 || echo "Delivery System Service")
            echo "package-type=maven" >> $GITHUB_OUTPUT
            echo "package-group-id=$GROUP_ID" >> $GITHUB_OUTPUT
            echo "package-artifact-id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
            echo "package-version=$VERSION" >> $GITHUB_OUTPUT
            echo "package-description=$DESCRIPTION" >> $GITHUB_OUTPUT
          elif [ -f "package.json" ]; then
            # Extract npm package info
            NAME=$(node -p "require('./package.json').name || 'unknown'")
            VERSION=$(node -p "require('./package.json').version || 'unknown'")
            DESCRIPTION=$(node -p "require('./package.json').description || 'Delivery System Service'")
            echo "package-type=npm" >> $GITHUB_OUTPUT
            echo "package-name=$NAME" >> $GITHUB_OUTPUT
            echo "package-version=$VERSION" >> $GITHUB_OUTPUT
            echo "package-description=$DESCRIPTION" >> $GITHUB_OUTPUT
          else
            echo "package-type=unknown" >> $GITHUB_OUTPUT
            echo "package-version=unknown" >> $GITHUB_OUTPUT
            echo "package-description=Delivery System Service" >> $GITHUB_OUTPUT
          fi

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.REPOSITORY_OWNER }}/${{ env.IMAGE_NAME_PREFIX }}-${{ matrix.service.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=${{ matrix.service.name }}
            org.opencontainers.image.description=${{ steps.package-info.outputs.package-description }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.url=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.vendor=${{ env.REPOSITORY_OWNER }}
            org.opencontainers.image.version=${{ steps.package-info.outputs.package-version }}
            org.opencontainers.image.authors=${{ github.repository_owner }}
            com.ds.service.name=${{ matrix.service.name }}
            com.ds.service.path=${{ matrix.service.path }}
            com.ds.package.type=${{ steps.package-info.outputs.package-type }}
            com.ds.package.version=${{ steps.package-info.outputs.package-version }}
            com.ds.package.group-id=${{ steps.package-info.outputs.package-group-id }}
            com.ds.package.artifact-id=${{ steps.package-info.outputs.package-artifact-id }}
            com.ds.package.name=${{ steps.package-info.outputs.package-name }}
            com.ds.repository=${{ github.repository }}
            com.ds.branch=${{ github.ref_name }}
            com.ds.commit=${{ github.sha }}
            com.ds.workflow=${{ github.workflow }}
            com.ds.run-id=${{ github.run_id }}
            com.ds.run-number=${{ github.run_number }}

      - name: Build and push Docker image
        if: matrix.service.condition == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.path }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
