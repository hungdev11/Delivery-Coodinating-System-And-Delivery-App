name: Android App CI/CD Pipeline

on:
  push:
    branches: [ "main", "release/*" ]
    paths:
      - 'DeliveryApp/**'
      - '.github/workflows/android-app-ci-cd.yml'
  pull_request:
    branches: [ "main", "release/*" ]
    paths:
      - 'DeliveryApp/**'
      - '.github/workflows/android-app-ci-cd.yml'

jobs:
  # Job 1: Detect changes
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      delivery-app: ${{ steps.tag-check.outputs.delivery-app }}
      force-build: ${{ steps.check-force.outputs.force-build }}
      pre-release: ${{ steps.tag-check.outputs.pre-release }}
      latest: ${{ steps.tag-check.outputs.latest }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for force-build flag
        id: check-force
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          FORCE_ALL=false
          FORCE_ANDROID=false
          
          # Check for specific Android flag
          if echo "$COMMIT_MSG" | grep -qi '\[force-build-android\]'; then
            FORCE_ANDROID=true
            echo "force-build-android: detected"
          fi
          
          # Check for general force-build flag
          if echo "$COMMIT_MSG" | grep -qi '\[force-build\]'; then
            FORCE_ALL=true
            echo "force-build (all): detected"
          fi
          
          if [ "$FORCE_ANDROID" = "true" ] || [ "$FORCE_ALL" = "true" ]; then
            echo "force-build: true"
            echo "force-build=true" >> $GITHUB_OUTPUT
          else
            echo "force-build: false"
            echo "force-build=false" >> $GITHUB_OUTPUT
          fi

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            delivery-app:
              - 'DeliveryApp/**'
            cicd-file:
              - '.github/workflows/android-app-ci-cd.yml'
          list-files: shell

      - name: Check if CI/CD file changed
        id: check-cicd
        run: |
          if [ "${{ steps.changes.outputs.cicd-file }}" = "true" ]; then
            echo "cicd-changed=true" >> $GITHUB_OUTPUT
            echo "CI/CD file changed: forcing build"
          else
            echo "cicd-changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine final change status
        id: tag-check
        run: |
          EVENT_TYPE="${{ github.event_name }}"
          REF="${{ github.ref }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          ACTION="${{ github.event.action }}"
          FORCE="${{ steps.check-force.outputs.force-build }}"
          CICD_CHANGED="${{ steps.check-cicd.outputs.cicd-changed }}"
          
          PRE_RELEASE="false"
          LATEST="false"
          BUILD_APP="false"
          
          # Tag releases: always build
          if [[ "$REF" == refs/tags/* ]]; then
            echo "mode: tag release"
            BUILD_APP="true"
            LATEST="true"
          # PR events: only build pre-release when PR is opened/synchronize (not when merged/closed)
          elif [ "$EVENT_TYPE" = "pull_request" ]; then
            if [ "$BASE_REF" = "main" ] || [[ "$BASE_REF" =~ ^release/ ]]; then
              # Only build for opened/synchronize actions, skip for closed/merged
              if [ "$ACTION" != "closed" ]; then
                BUILD_APP="true"
                PRE_RELEASE="true"
              fi
            fi
          # Push events: build latest for main or release/* branches
          elif [ "$EVENT_TYPE" = "push" ]; then
            if [ "$REF" = "refs/heads/main" ] || [[ "$REF" =~ ^refs/heads/release/ ]]; then
              BUILD_APP="true"
              LATEST="true"
            elif [ "${{ steps.changes.outputs.delivery-app }}" = "true" ] || [ "$FORCE" = "true" ] || [ "$CICD_CHANGED" = "true" ]; then
              BUILD_APP="true"
            fi
          fi
          
          # Force build overrides
          if [ "$FORCE" = "true" ] || [ "$CICD_CHANGED" = "true" ]; then
            if [ "$CICD_CHANGED" = "true" ]; then
              echo "mode: force-build (CI/CD file changed)"
            else
              echo "mode: force-build (flag detected)"
            fi
            BUILD_APP="true"
          fi
          
          echo "delivery-app=$BUILD_APP" >> $GITHUB_OUTPUT
          echo "pre-release=$PRE_RELEASE" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          
          echo "Event type: $EVENT_TYPE"
          echo "Action: ${ACTION:-N/A}"
          echo "Pre-release: $PRE_RELEASE"
          echo "Latest: $LATEST"
          echo "Build app: $BUILD_APP"
  # Job 2: Run Unit Tests
  test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.delivery-app == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
          cache-dependency-path: DeliveryApp/gradle/libs.versions.toml
      
      - name: Grant execute permission for gradlew
        working-directory: DeliveryApp
        run: chmod +x gradlew
      
      - name: Run unit tests
        working-directory: DeliveryApp
        run: ./gradlew test --no-daemon || echo "Tests completed with warnings"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: DeliveryApp/app/build/test-results/
          retention-days: 7
          if-no-files-found: ignore

  # Job 3: Build APK
  build-apk:
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: |
      needs.detect-changes.outputs.delivery-app == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
          cache-dependency-path: DeliveryApp/gradle/libs.versions.toml
      
      - name: Grant execute permission for gradlew
        working-directory: DeliveryApp
        run: chmod +x gradlew
      
      - name: Build Debug APK
        working-directory: DeliveryApp
        run: ./gradlew assembleDebug --no-daemon
      
      - name: List APK outputs
        working-directory: DeliveryApp
        run: |
          echo "Debug APKs:"
          find app/build/outputs/apk/debug -name "*.apk" 2>/dev/null || echo "  none"
      
      - name: Upload Debug APK (with SHA tag)
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-debug-apk-sha-${{ github.sha }}
          path: DeliveryApp/app/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload Debug APK (pre-release tag)
        if: needs.detect-changes.outputs.pre-release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-debug-apk-pre-release
          path: DeliveryApp/app/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload Debug APK (latest tag)
        if: needs.detect-changes.outputs.latest == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-debug-apk-latest
          path: DeliveryApp/app/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: warn

  # Job 4: Build Signed Release (APK & AAB)
  build-signed-release:
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: |
      needs.detect-changes.outputs.delivery-app == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/'))
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
          cache-dependency-path: DeliveryApp/gradle/libs.versions.toml
      
      - name: Setup Android Signing
        working-directory: DeliveryApp
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          chmod +x scripts/setup-signing.sh
          ./scripts/setup-signing.sh
      
      - name: Grant execute permission for gradlew
        working-directory: DeliveryApp
        run: chmod +x gradlew
      
      - name: Build Signed Release APK
        working-directory: DeliveryApp
        run: ./gradlew assembleRelease --no-daemon
      
      - name: Build Signed Release AAB
        working-directory: DeliveryApp
        run: ./gradlew bundleRelease --no-daemon
      
      - name: Verify signed artifacts
        working-directory: DeliveryApp
        run: |
          echo "Verifying signed APK:"
          jarsigner -verify -verbose -certs app/build/outputs/apk/release/*.apk || echo "Warning: APK verification check"
          echo ""
          echo "Release APK found:"
          find app/build/outputs/apk/release -name "*.apk" || echo "  none"
          echo ""
          echo "Release AAB found:"
          find app/build/outputs/bundle/release -name "*.aab" || echo "  none"
      
      - name: Upload Signed Release APK (with SHA tag)
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-signed-release-apk-sha-${{ github.sha }}
          path: DeliveryApp/app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: warn
      
      - name: Upload Signed Release APK (pre-release tag)
        if: needs.detect-changes.outputs.pre-release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-signed-release-apk-pre-release
          path: DeliveryApp/app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: warn
      
      - name: Upload Signed Release APK (latest tag)
        if: needs.detect-changes.outputs.latest == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-signed-release-apk-latest
          path: DeliveryApp/app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: warn
      
      - name: Upload Signed Release AAB (with SHA tag)
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-signed-release-aab-sha-${{ github.sha }}
          path: DeliveryApp/app/build/outputs/bundle/release/*.aab
          retention-days: 90
          if-no-files-found: warn
      
      - name: Upload Signed Release AAB (pre-release tag)
        if: needs.detect-changes.outputs.pre-release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-signed-release-aab-pre-release
          path: DeliveryApp/app/build/outputs/bundle/release/*.aab
          retention-days: 90
          if-no-files-found: warn
      
      - name: Upload Signed Release AAB (latest tag)
        if: needs.detect-changes.outputs.latest == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-signed-release-aab-latest
          path: DeliveryApp/app/build/outputs/bundle/release/*.aab
          retention-days: 90
          if-no-files-found: warn
      
      - name: Cleanup sensitive files
        if: always()
        working-directory: DeliveryApp
        run: |
          rm -f app/release.keystore
          rm -f app/keystore.properties
          echo "Sensitive files cleaned up"

  # Job 5: Create GitHub Release (on tags)
  release:
    runs-on: ubuntu-latest
    needs: [build-apk, build-signed-release]
    if: |
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts for release
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: delivery-app-*-latest
          merge-multiple: true
          path: ./artifacts
      
      - name: Download artifacts by SHA (fallback)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: delivery-app-*-sha-${{ github.sha }}
          merge-multiple: true
          path: ./artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/*.apk
            ./artifacts/*.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
