name: Android App CI/CD Pipeline

on:
  push:
    branches: [ "main", "release/*" ]
    paths:
      - 'DeliveryApp/**'
      - '.github/workflows/android-app-ci-cd.yml'
  pull_request:
    branches: [ "main", "release/*" ]
    paths:
      - 'DeliveryApp/**'
      - '.github/workflows/android-app-ci-cd.yml'

jobs:
  # Job 1: Detect changes
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      delivery-app: ${{ steps.tag-check.outputs.delivery-app }}
      force-build: ${{ steps.check-force.outputs.force-build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for force-build flag
        id: check-force
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if echo "$COMMIT_MSG" | grep -qi '\[force-build\]'; then
            echo "force-build: true"
            echo "force-build=true" >> $GITHUB_OUTPUT
          else
            echo "force-build: false"
            echo "force-build=false" >> $GITHUB_OUTPUT
          fi

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            delivery-app:
              - 'DeliveryApp/**'
            cicd-file:
              - '.github/workflows/android-app-ci-cd.yml'
          list-files: shell
      - name: Check if CI/CD file changed
        id: check-cicd
        run: |
          if [ "${{ steps.changes.outputs.cicd-file }}" = "true" ]; then
            echo "cicd-changed=true" >> $GITHUB_OUTPUT
            echo "CI/CD file changed: forcing build"
          else
            echo "cicd-changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine final change status
        id: tag-check
        run: |
          FORCE="${{ steps.check-force.outputs.force-build }}"
          CICD_CHANGED="${{ steps.check-cicd.outputs.cicd-changed }}"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "mode: tag release"
            echo "delivery-app=true" >> $GITHUB_OUTPUT
          elif [ "$FORCE" = "true" ] || [ "$CICD_CHANGED" = "true" ]; then
            if [ "$CICD_CHANGED" = "true" ]; then
              echo "mode: force-build (CI/CD file changed)"
            else
              echo "mode: force-build (flag detected)"
            fi
            echo "delivery-app=true" >> $GITHUB_OUTPUT
          else
            echo "mode: change-detection"
            echo "delivery-app=${{ steps.changes.outputs.delivery-app }}" >> $GITHUB_OUTPUT
          fi
          
          echo "delivery-app: ${{ steps.changes.outputs.delivery-app }}"
  # Job 2: Run Unit Tests
  test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.delivery-app == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
          cache-dependency-path: DeliveryApp/gradle/libs.versions.toml
      
      - name: Grant execute permission for gradlew
        working-directory: DeliveryApp
        run: chmod +x gradlew
      
      - name: Run unit tests
        working-directory: DeliveryApp
        run: ./gradlew test --no-daemon || echo "Tests completed with warnings"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: DeliveryApp/app/build/test-results/
          retention-days: 7
          if-no-files-found: ignore

  # Job 3: Build APK
  build-apk:
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: |
      needs.detect-changes.outputs.delivery-app == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
          cache-dependency-path: DeliveryApp/gradle/libs.versions.toml
      
      - name: Grant execute permission for gradlew
        working-directory: DeliveryApp
        run: chmod +x gradlew
      
      - name: Build Debug APK
        working-directory: DeliveryApp
        run: ./gradlew assembleDebug --no-daemon
      
      - name: List APK outputs
        working-directory: DeliveryApp
        run: |
          echo "Debug APKs:"
          find app/build/outputs/apk/debug -name "*.apk" 2>/dev/null || echo "  none"
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-debug-apk
          path: DeliveryApp/app/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: warn

  # Job 4: Build Signed Release (APK & AAB)
  build-signed-release:
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: |
      needs.detect-changes.outputs.delivery-app == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/'))
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
          cache-dependency-path: DeliveryApp/gradle/libs.versions.toml
      
      - name: Setup Android Signing
        working-directory: DeliveryApp
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          chmod +x scripts/setup-signing.sh
          ./scripts/setup-signing.sh
      
      - name: Grant execute permission for gradlew
        working-directory: DeliveryApp
        run: chmod +x gradlew
      
      - name: Build Signed Release APK
        working-directory: DeliveryApp
        run: ./gradlew assembleRelease --no-daemon
      
      - name: Build Signed Release AAB
        working-directory: DeliveryApp
        run: ./gradlew bundleRelease --no-daemon
      
      - name: Verify signed artifacts
        working-directory: DeliveryApp
        run: |
          echo "Verifying signed APK:"
          jarsigner -verify -verbose -certs app/build/outputs/apk/release/*.apk || echo "Warning: APK verification check"
          echo ""
          echo "Release APK found:"
          find app/build/outputs/apk/release -name "*.apk" || echo "  none"
          echo ""
          echo "Release AAB found:"
          find app/build/outputs/bundle/release -name "*.aab" || echo "  none"
      
      - name: Upload Signed Release APK
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-signed-release-apk
          path: DeliveryApp/app/build/outputs/apk/release/*.apk
          retention-days: 90
          if-no-files-found: warn
      
      - name: Upload Signed Release AAB
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-signed-release-aab
          path: DeliveryApp/app/build/outputs/bundle/release/*.aab
          retention-days: 90
          if-no-files-found: warn
      
      - name: Cleanup sensitive files
        if: always()
        working-directory: DeliveryApp
        run: |
          rm -f app/release.keystore
          rm -f app/keystore.properties
          echo "Sensitive files cleaned up"

  # Job 5: Create GitHub Release (on tags)
  release:
    runs-on: ubuntu-latest
    needs: [build-apk, build-signed-release]
    if: |
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Debug APK
        uses: actions/download-artifact@v4
        with:
          name: delivery-app-debug-apk
          path: ./artifacts
      
      - name: Download Signed Release APK
        uses: actions/download-artifact@v4
        with:
          name: delivery-app-signed-release-apk
          path: ./artifacts
      
      - name: Download Signed Release AAB
        uses: actions/download-artifact@v4
        with:
          name: delivery-app-signed-release-aab
          path: ./artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/*.apk
            ./artifacts/*.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
