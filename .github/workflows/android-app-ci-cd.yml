name: Android App CI/CD Pipeline

on:
  push:
    branches: [ "main", "release/*" ]
    paths:
      - 'DeliveryApp/**'
      - '.github/workflows/android-app-ci-cd.yml'
  pull_request:
    branches: [ "main", "release/*" ]
    paths:
      - 'DeliveryApp/**'
      - '.github/workflows/android-app-ci-cd.yml'

jobs:
  # Job 1: Detect changes
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      delivery-app: ${{ steps.tag-check.outputs.delivery-app }}
      force-build: ${{ steps.check-force.outputs.force-build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for force-build flag
        id: check-force
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if echo "$COMMIT_MSG" | grep -qi '\[force-build\]'; then
            echo "ðŸ”¨ Force build detected in commit message"
            echo "force-build=true" >> $GITHUB_OUTPUT
          else
            echo "force-build=false" >> $GITHUB_OUTPUT
          fi

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            delivery-app:
              - 'DeliveryApp/**'
          list-files: shell
      - name: Determine final change status
        id: tag-check
        run: |
          FORCE="${{ steps.check-force.outputs.force-build }}"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "delivery-app=true" >> $GITHUB_OUTPUT
          elif [ "$FORCE" = "true" ]; then
            echo "ðŸ”¨ Force build: marking delivery-app as changed"
            echo "delivery-app=true" >> $GITHUB_OUTPUT
          else
            echo "delivery-app=${{ steps.changes.outputs.delivery-app }}" >> $GITHUB_OUTPUT
          fi
  # Job 2: Run Unit Tests
  test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.delivery-app == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
          cache-dependency-path: DeliveryApp/gradle/libs.versions.toml
      
      - name: Grant execute permission for gradlew
        working-directory: DeliveryApp
        run: chmod +x gradlew
      
      - name: Run unit tests
        working-directory: DeliveryApp
        run: ./gradlew test --no-daemon || echo "Tests completed with warnings"
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: DeliveryApp/app/build/test-results/
          retention-days: 7
          if-no-files-found: ignore

  # Job 3: Build APK
  build-apk:
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: |
      needs.detect-changes.outputs.delivery-app == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
          cache-dependency-path: DeliveryApp/gradle/libs.versions.toml
      
      - name: Grant execute permission for gradlew
        working-directory: DeliveryApp
        run: chmod +x gradlew
      
      - name: Build Debug APK
        working-directory: DeliveryApp
        run: ./gradlew assembleDebug --no-daemon
      
      - name: Build Release APK (unsigned)
        working-directory: DeliveryApp
        run: ./gradlew assembleRelease --no-daemon
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-debug-apk
          path: DeliveryApp/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
      
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-release-apk
          path: DeliveryApp/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

  # Job 4: Build AAB (Android App Bundle) - for Play Store
  build-aab:
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: |
      needs.detect-changes.outputs.delivery-app == 'true' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
          cache-dependency-path: DeliveryApp/gradle/libs.versions.toml
      
      - name: Grant execute permission for gradlew
        working-directory: DeliveryApp
        run: chmod +x gradlew
      
      - name: Build Release AAB
        working-directory: DeliveryApp
        run: ./gradlew bundleRelease --no-daemon
      
      - name: Upload Release AAB
        uses: actions/upload-artifact@v4
        with:
          name: delivery-app-release-aab
          path: DeliveryApp/app/build/outputs/bundle/release/app-release.aab
          retention-days: 90

  # Job 5: Create GitHub Release (on tags)
  release:
    runs-on: ubuntu-latest
    needs: [build-apk, build-aab]
    if: |
      github.event_name == 'push' &&
      startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Debug APK
        uses: actions/download-artifact@v4
        with:
          name: delivery-app-debug-apk
          path: ./artifacts
      
      - name: Download Release APK
        uses: actions/download-artifact@v4
        with:
          name: delivery-app-release-apk
          path: ./artifacts
      
      - name: Download Release AAB
        uses: actions/download-artifact@v4
        with:
          name: delivery-app-release-aab
          path: ./artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./artifacts/app-debug.apk
            ./artifacts/app-release.apk
            ./artifacts/app-release.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
