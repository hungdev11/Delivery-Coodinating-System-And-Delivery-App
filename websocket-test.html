<!DOCTYPE html>
<html>
<head>
    <title>WebSocket STOMP Test</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .user-panel {
            flex: 1;
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 15px;
        }
        .user-panel.connected {
            border-color: #4CAF50;
        }
        .user-panel h2 {
            margin-top: 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .disconnect {
            background: #f44336;
        }
        .disconnect:hover {
            background: #da190b;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            box-sizing: border-box;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        .message.sent {
            background: #E3F2FD;
            text-align: right;
        }
        .message.received {
            background: #F1F8E9;
        }
        .status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .log {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>WebSocket STOMP Test - Two Users</h1>
    
    <div class="container">
        <!-- User A Panel -->
        <div class="user-panel" id="panelA">
            <h2>User A</h2>
            <div>
                <strong>User ID:</strong>
                <input type="text" id="userIdA" value="62b08293-e714-45e1-9bec-a4a7e9e1bc71" />
            </div>
            <div>
                <button id="connectA">Connect</button>
                <button id="disconnectA" class="disconnect" disabled>Disconnect</button>
            </div>
            <div>
                <strong>Recipient ID:</strong>
                <input type="text" id="recipientA" value="659235bc-60c6-45b3-bab8-2adb83b0892e" />
            </div>
            <div>
                <strong>Message:</strong>
                <input type="text" id="messageA" placeholder="Type message..." />
                <button id="sendA" disabled>Send</button>
            </div>
            <div>
                <strong>Messages:</strong>
                <div class="messages" id="messagesA"></div>
            </div>
            <div>
                <strong>Log:</strong>
                <div class="log" id="logA"></div>
            </div>
        </div>

        <!-- User B Panel -->
        <div class="user-panel" id="panelB">
            <h2>User B</h2>
            <div>
                <strong>User ID:</strong>
                <input type="text" id="userIdB" value="659235bc-60c6-45b3-bab8-2adb83b0892e" />
            </div>
            <div>
                <button id="connectB">Connect</button>
                <button id="disconnectB" class="disconnect" disabled>Disconnect</button>
            </div>
            <div>
                <strong>Recipient ID:</strong>
                <input type="text" id="recipientB" value="62b08293-e714-45e1-9bec-a4a7e9e1bc71" />
            </div>
            <div>
                <strong>Message:</strong>
                <input type="text" id="messageB" placeholder="Type message..." />
                <button id="sendB" disabled>Send</button>
            </div>
            <div>
                <strong>Messages:</strong>
                <div class="messages" id="messagesB"></div>
            </div>
            <div>
                <strong>Log:</strong>
                <div class="log" id="logB"></div>
            </div>
        </div>
    </div>

    <script>
        // const WS_URL = 'https://localweb.phuongy.works/ws';
        const WS_URL = 'http://localhost:21511/ws';
        
        class UserConnection {
            constructor(userId, logElementId, messagesElementId, panelId) {
                this.userId = userId;
                this.logElement = document.getElementById(logElementId);
                this.messagesElement = document.getElementById(messagesElementId);
                this.panelElement = document.getElementById(panelId);
                this.stompClient = null;
                this.connected = false;
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.logElement.innerHTML += `[${timestamp}] ${message}<br>`;
                this.logElement.scrollTop = this.logElement.scrollHeight;
            }

            addMessage(message, isSent) {
                const div = document.createElement('div');
                div.className = 'message ' + (isSent ? 'sent' : 'received');
                div.innerHTML = `
                    <div><strong>${isSent ? 'You' : 'Them'}:</strong> ${message.content}</div>
                    <div class="status">
                        ID: ${message.id?.substring(0, 8)}... | 
                        Status: ${message.status} | 
                        ${new Date(message.sentAt).toLocaleTimeString()}
                    </div>
                `;
                this.messagesElement.appendChild(div);
                this.messagesElement.scrollTop = this.messagesElement.scrollHeight;
            }

            connect() {
                this.log('ðŸ”Œ Connecting to ' + WS_URL);
                
                const socket = new SockJS(WS_URL);
                this.stompClient = Stomp.over(socket);
                
                // Debug: show STOMP frames
                this.stompClient.debug = (msg) => {
                    if (msg.startsWith('>>> ') || msg.startsWith('<<< ')) {
                        this.log('ðŸ“¡ ' + msg.substring(0, 100));
                    }
                };

                const connectHeaders = {
                    'Authorization': 'Bearer ' + this.userId
                };

                this.stompClient.connect(
                    connectHeaders,
                    (frame) => {
                        this.log('âœ… Connected: ' + frame.command);
                        this.connected = true;
                        this.panelElement.classList.add('connected');
                        this.subscribe();
                    },
                    (error) => {
                        this.log('âŒ Error: ' + error);
                        this.connected = false;
                        this.panelElement.classList.remove('connected');
                    }
                );
            }

            subscribe() {
                // Subscribe to user-specific queue
                // Spring's SimpleBroker will transform /user/{userId}/queue/messages 
                // to /queue/messages-user{sessionId} but STOMP.js handles this automatically
                const destination = '/user/queue/messages';
                this.log('ðŸ“¬ Subscribing to: ' + destination + ' (user: ' + this.userId + ')');
                
                const subscription = this.stompClient.subscribe(destination, (message) => {
                    this.log('ðŸ“¨ Message received: ' + message.body.substring(0, 100));
                    try {
                        const msg = JSON.parse(message.body);
                        this.log('âœ… Parsed message ID: ' + (msg.id || 'unknown'));
                        const isSent = msg.senderId === this.userId;
                        this.addMessage(msg, isSent);
                    } catch (e) {
                        this.log('âŒ Error parsing message: ' + e.message);
                    }
                });
                
                this.log('âœ… Subscription created with ID: ' + subscription.id);
                this.log('ðŸ’¡ SimpleBroker will route to session-specific destination automatically');
            }

            sendMessage(content, recipientId) {
                if (!this.connected) {
                    this.log('âŒ Not connected');
                    return;
                }

                const payload = {
                    content: content,
                    recipientId: recipientId
                };

                this.log('ðŸ“¤ Sending message: ' + content + ' to: ' + recipientId);
                this.log('ðŸ“¤ Payload: ' + JSON.stringify(payload));
                
                try {
                    this.stompClient.send('/app/chat.send', {}, JSON.stringify(payload));
                    this.log('âœ… Message sent via STOMP');
                } catch (e) {
                    this.log('âŒ Error sending message: ' + e.message);
                }
            }

            disconnect() {
                if (this.stompClient) {
                    this.stompClient.disconnect(() => {
                        this.log('ðŸ‘‹ Disconnected');
                        this.connected = false;
                        this.panelElement.classList.remove('connected');
                    });
                }
            }
        }

        // Initialize User A
        const userA = new UserConnection(
            document.getElementById('userIdA').value,
            'logA',
            'messagesA',
            'panelA'
        );

        // Initialize User B
        const userB = new UserConnection(
            document.getElementById('userIdB').value,
            'logB',
            'messagesB',
            'panelB'
        );

        // User A Controls
        document.getElementById('connectA').addEventListener('click', () => {
            userA.userId = document.getElementById('userIdA').value;
            userA.connect();
            document.getElementById('connectA').disabled = true;
            document.getElementById('disconnectA').disabled = false;
            document.getElementById('sendA').disabled = false;
        });

        document.getElementById('disconnectA').addEventListener('click', () => {
            userA.disconnect();
            document.getElementById('connectA').disabled = false;
            document.getElementById('disconnectA').disabled = true;
            document.getElementById('sendA').disabled = true;
        });

        document.getElementById('sendA').addEventListener('click', () => {
            const message = document.getElementById('messageA').value;
            const recipient = document.getElementById('recipientA').value;
            if (message) {
                userA.sendMessage(message, recipient);
                document.getElementById('messageA').value = '';
            }
        });

        document.getElementById('messageA').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendA').click();
            }
        });

        // User B Controls
        document.getElementById('connectB').addEventListener('click', () => {
            userB.userId = document.getElementById('userIdB').value;
            userB.connect();
            document.getElementById('connectB').disabled = true;
            document.getElementById('disconnectB').disabled = false;
            document.getElementById('sendB').disabled = false;
        });

        document.getElementById('disconnectB').addEventListener('click', () => {
            userB.disconnect();
            document.getElementById('connectB').disabled = false;
            document.getElementById('disconnectB').disabled = true;
            document.getElementById('sendB').disabled = true;
        });

        document.getElementById('sendB').addEventListener('click', () => {
            const message = document.getElementById('messageB').value;
            const recipient = document.getElementById('recipientB').value;
            if (message) {
                userB.sendMessage(message, recipient);
                document.getElementById('messageB').value = '';
            }
        });

        document.getElementById('messageB').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendB').click();
            }
        });
    </script>
</body>
</html>
